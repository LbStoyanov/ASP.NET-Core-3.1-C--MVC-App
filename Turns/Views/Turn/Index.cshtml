@model Turns.Models.Turn;

@{
    ViewBag.Title = "Turns assignment";
}

<div class="row">
    <div class="col s6">
        <label asp-for="DoctorId">Doctor</label>
        <select asp-for="DoctorId" asp-items="ViewBag.DoctorId"></select>
    </div>
      <div class="col s6">
        <label asp-for="PatientId">Patient</label>
        <select asp-for="PatientId" asp-items="ViewBag.PatientId"></select>
    </div>
</div>

<br>

<div id="HoursCalendar"></div>

<link href="~/fullcalendar/fullcalendar.css" rel="stylesheet"/>
<link href="~/fullcalendar/fullcalendar.print.css" rel="stylesheet" media="print"/>

@section Scripts{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="~/fullcalendar/fullcalendar.min.js"></script>
    <script>
        $(document).ready(function () {
            var workingTimeFrom = "";
            var workingTimeTo = "";
            var turns = [];

            GetTurnsAndUpdateCalendar($('#DoctorId').val());

            function GetTurnsAndUpdateCalendar (doctorId){
                turns = [];
                $.ajax({
                    type: 'GET',
                    url: "Turn/GetTurns",
                    data: { 'DoctorId': doctorId },
                    success: function (data) {
                        $.each(data, function (i, v){
                            turns.push({
                                turnId: v.turnId,
                                patientId: v.patientId,
                                doctorId: v.doctorId,
                                start: moment(v.workingTimeStart),
                                end: v.workingTimeEnd != null ? moment(v.workingTimeEnd) : null,
                            })
                        })
                        GenerateCalendar(turns);
                    },
                    error: function (){
                        alert('Error when try go get turns!');
                    }
                })
            }

            function GenerateCalendar (turns){

                $.ajax({
                type: "GET",
                url: "Doctor/SetWorkingTimeFrom",
                data: {"doctorId": $('#DoctorId').val() },
                async: false,
                success: function (result){
                    workingTimeFrom = result;
                },
                error: function () {
                    alert("Error: Selected doctor's working time from is not found! ");
                }
            });

            $.ajax({
                type: "GET",
                url: "Doctor/SetWorkingTimeTo",
                data: {"doctorId": $('#DoctorId').val() },
                async: false,
                success: function (result){
                    workingTimeTo = result;
                },
                error: function () {
                    alert("Error: Selected doctor's working time to is not found! ");
                }
            });

            $('#HoursCalendar').fullCalendar('destroy');

            $('#HoursCalendar').fullCalendar({
                contentHeight: 'auto',
                defaultDate: new Date(),
                slotLabelFormat: "HH:mm",
                defaultView: 'agendaWeek',
                header: {
                    left: 'prev, next today',
                    right: 'month,agendaWeek,agendaDay',
                },
                slotDuration: '00:30',
                nowIndicator: true,
                allDaySlot: false,
                selectable: true,
                eventLimit: true,
                minTime: workingTimeFrom,
                maxTime: workingTimeTo,
            })
            }
            
        })
    </script>
}